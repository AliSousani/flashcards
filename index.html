<!doctype html>
<html lang="fa" dir="rtl">
<head> 
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>فلش‌کارت فارسی → انگلیسی — نسخه‌ی جدید</title>
  <meta name="theme-color" content="#0f1117">
  <style>
    @font-face{
      font-family:"Vazirmatn";
      src: url("https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/variable/Vazirmatn[wght].woff2") format("woff2");
      font-display:swap;
    }
    :root{
      --bg:#0f1117; --panel:#141925; --surface:#0f1420; --text:#e9eef5; --muted:#9dacbf;
      --border:#24304a; --accent:#74b9ff; --ok:#2ecc71; --warn:#ff7675; --chip:#1a2132;
      --radius:16px; --radius-sm:12px; --shadow:0 12px 34px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Vazirmatn,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans",Tahoma}
    .wrap{max-width:860px;margin:18px auto 80px;padding:0 14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
    .card+.card{margin-top:14px}
    h1,h2{margin:0 0 10px 0}
    h1{font-size:20px}
    h2{font-size:18px}
    .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 220px}
    input,select,textarea,button{
      width:100%;background:var(--surface);color:var(--text);border:1px solid var(--border);
      padding:12px;border-radius:var(--radius-sm);font-size:15px;outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    button{cursor:pointer;font-weight:700}
    button.primary{background:linear-gradient(135deg,var(--accent),#a4d3ff);color:#041321;border:0}
    button.ok{background:linear-gradient(135deg,#33df98,#bff5dc);color:#04241a;border:0}
    button.warn{background:linear-gradient(135deg,#ff6b6b,#ffc6c6);color:#2a0000;border:0}
    button.ghost{background:transparent;border:1px dashed var(--border)}
    button.secondary{background:#1a2336;border:1px solid #2b3958}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .badge{background:var(--chip);border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .big{background:radial-gradient(1000px 200px at 50% 0%,#0d121e 0,#0b0f19 60%,#090d15 100%);border:1px dashed var(--border);border-radius:var(--radius);padding:20px;min-height:140px;text-align:center}
    .faText{font-size:22px;line-height:1.9;white-space:pre-wrap}
    .enText{font-size:18px;line-height:1.7;white-space:pre-wrap;color:#d4ffe7}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:13px;color:var(--text)}
    .grid-mini{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:540px){.grid-mini{grid-template-columns:1fr}}
    .item{background:#0e1422;border:1px solid var(--border);border-radius:12px;padding:10px}
    .hint{color:var(--muted);font-size:12px}
    .uid{direction:ltr;text-align:left}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f131a;border:1px solid var(--border);padding:10px 14px;border-radius:12px;display:none;z-index:5}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="card" style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <div>
        <h1>فلش‌کارت فارسی → انگلیسی</h1>
        <div class="muted">نسخه‌ی گرافیکی + سرفصل + فیلتر | مناسب iPhone 13 Pro Max</div>
      </div>
      <div class="badge" id="totalBadge">۰ کارت</div>
    </header>

    <section class="card" id="viewer">
      <h2>نمایش کارت‌ها</h2>
      <div class="row" style="margin:8px 0 10px">
        <div>
          <label class="hint">سرفصلِ نمایش</label>
          <select id="filterCategory"></select>
        </div>
        <div>
          <label class="hint">حالت نمایش</label>
          <select id="viewMode">
            <option value="repeat">فقط «تکرار»</option>
            <option value="all">همه کارت‌ها</option>
          </select>
        </div>
        <div>
          <label class="hint">ترتیب</label>
          <select id="viewOrder">
            <option value="asc">قدیمی → جدید</option>
            <option value="desc">جدید → قدیمی</option>
            <option value="random">تصادفی</option>
          </select>
        </div>
      </div>

      <div class="big">
        <div id="faText" class="faText">— هنوز کارتی اضافه نشده —</div>
        <div class="hr"></div>
        <div id="enText" class="enText" style="display:none">English appears here.</div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="prevBtn" class="secondary">← قبلی</button>
        <button id="toggleEnBtn" class="ghost">نمایش ترجمه</button>
        <button id="nextBtn" class="secondary">بعدی →</button>
        <button id="markSuccessBtn" class="ok">✓ موفق</button>
        <button id="incRepeatBtn" class="secondary">↻ +1 تکرار</button>
      </div>
    </section>

    <section class="card">
      <h2>تنظیماتِ نمایش</h2>
      <div class="chips">
        <button id="hideSuccessOn" class="chip">پنهان کردن موفق‌ها (روشن)</button>
        <button id="hideSuccessOff" class="chip">نمایش موفق‌ها</button>
      </div>
      <p class="hint" style="margin-top:8px">برای تمرکز روی تمرین‌ها، «پنهان کردن موفق‌ها» را روشن نگه‌دار.</p>
    </section>

    <section class="card">
      <h2>افزودن کارت (با سرفصل)</h2>
      <div class="row">
        <div>
          <label class="hint">انتخاب سرفصل</label>
          <select id="categorySelect"></select>
        </div>
        <div>
          <label class="hint">ایجاد سرفصل جدید (اختیاری)</label>
          <input id="newCategoryInput" placeholder="مثال: کتاب تاچ‌استون ۲ / درس ۱">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label class="hint">جملهٔ فارسی</label>
          <textarea id="faInput" placeholder="متن فارسی..."></textarea>
        </div>
        <div>
          <label class="hint">ترجمهٔ انگلیسی</label>
          <textarea id="enInput" placeholder="English translation..."></textarea>
        </div>
      </div>

      <div class="toolbar" style="margin-top:8px">
        <button id="addBtn" class="primary">افزودن/ذخیره</button>
        <button id="clearBtn" class="ghost">پاک‌کردن ورودی‌ها</button>
        <button id="deleteBtn" class="warn">حذف کارت فعلی</button>
      </div>
    </section>

    <section class="card">
      <h2>آخرین کارت‌های این سرفصل</h2>
      <div id="recentList" class="grid-mini"></div>
    </section>

    <section class="card">
      <h2>شناسهٔ مشترک (UID)</h2>
      <div class="row">
        <div>
          <input id="uidInput" class="uid" placeholder="مثلاً u_r1155ctieycme9scf1">
        </div>
        <div style="flex:0 0 180px">
          <button id="saveUidBtn" class="secondary">تعیین/تغییر شناسه</button>
        </div>
      </div>
      <p class="hint" style="margin-top:8px">همین UID را در همه دستگاه‌ها بزن تا داده‌ها یکی باشند.</p>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, collection, setDoc, addDoc, getDoc, getDocs,
      query, where, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCI1jW-3NwZtJEXfyx1Pp0lTg9EyM4xwLQ",
      authDomain: "flashcards-7ea58.firebaseapp.com",
      projectId: "flashcards-7ea58",
      storageBucket: "flashcards-7ea58.firebasestorage.app",
      messagingSenderId: "1031346115685",
      appId: "1:1031346115685:web:afe231ee4dab6bf6ffa28c",
      measurementId: "G-VQECY29XS4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = id => document.getElementById(id);
    const toastBox = $('toast');
    const totalBadge = $('totalBadge');

    const filterCategory = $('filterCategory');
    const viewMode = $('viewMode');
    const viewOrder = $('viewOrder');
    const faText = $('faText');
    const enText = $('enText');
    const prevBtn = $('prevBtn');
    const nextBtn = $('nextBtn');
    const toggleEnBtn = $('toggleEnBtn');
    const markSuccessBtn = $('markSuccessBtn');
    const incRepeatBtn = $('incRepeatBtn');
    const hideSuccessOn = $('hideSuccessOn');
    const hideSuccessOff = $('hideSuccessOff');
    const categorySelect = $('categorySelect');
    const newCategoryInput = $('newCategoryInput');
    const faInput = $('faInput');
    const enInput = $('enInput');
    const addBtn = $('addBtn');
    const clearBtn = $('clearBtn');
    const deleteBtn = $('deleteBtn');
    const recentList = $('recentList');
    const uidInput = $('uidInput');
    const saveUidBtn = $('saveUidBtn');

    let UID = localStorage.getItem('flash_uid') || '';
    if(UID) uidInput.value = UID;
    let hideSuccess = (localStorage.getItem('hide_success')==='1');
    let cards = [];
    let idx = 0;

    function toast(msg){
      toastBox.textContent = msg;
      toastBox.style.display = 'block';
      setTimeout(()=> toastBox.style.display='none', 1600);
    }

    const userRef = () => doc(db, 'users', UID);
    const catsCol = () => collection(userRef(), 'categories');
    const cardsCol = () => collection(userRef(), 'cards');
    function ensureUID(){ if(!UID){ alert('اول UID را در پایین صفحه تنظیم کن.'); return false; } return true; }

    async function loadCategories(){
      if(!ensureUID()) return;
      categorySelect.innerHTML = '';
      filterCategory.innerHTML = '';
      const all = document.createElement('option'); all.value='__ALL__'; all.textContent='همه سرفصل‌ها';
      filterCategory.appendChild(all);

      const snap = await getDocs(catsCol());
      if(snap.empty){ await setDoc(doc(catsCol(),'default'), {name:'عمومی'}); }
      const snap2 = await getDocs(catsCol());
      snap2.forEach(d=>{
        const name = d.data()?.name;
        if(!name) return;
        const o1=document.createElement('option'); o1.value=name; o1.textContent=name; categorySelect.appendChild(o1);
        const o2=document.createElement('option'); o2.value=name; o2.textContent=name; filterCategory.appendChild(o2);
      });
      if(filterCategory.options.length>1 && filterCategory.value===''){ filterCategory.selectedIndex = 1; }
    }
    async function ensureCategory(name){
      const snap=await getDocs(catsCol());
      let ok=false; snap.forEach(d=>{ if(d.data()?.name===name) ok=true; });
      if(!ok){ await setDoc(doc(catsCol(), name.toLowerCase().replace(/\s+/g,'-')||('cat-'+Date.now())), {name}); }
    }

    async function loadCards(){
      if(!ensureUID()) return;
      const cat = filterCategory.value;
      let qRef;
      if(cat && cat!=='__ALL__'){ qRef=query(cardsCol(), where('category','==',cat)); }
      else{ qRef=query(cardsCol()); }
      const snap = await getDocs(qRef);
      let arr=[]; snap.forEach(d=> arr.push({id:d.id, ...d.data(), _ref:doc(cardsCol(), d.id)}));

      const mode=viewMode.value;
      if(hideSuccess || mode==='repeat') arr=arr.filter(x=>!x.success);
      arr.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
      if(viewOrder.value==='desc') arr.reverse();
      if(viewOrder.value==='random') arr.sort(()=>Math.random()-0.5);
      cards=arr; idx=0; // فقط هنگام بارگذاری/تغییر فیلتر ریست می‌کنیم
      totalBadge.textContent = cards.length + ' کارت';
      renderCard();
    }

    function renderCard(){
      const c = cards[idx];
      if(!c){ faText.textContent='— هنوز کارتی اضافه نشده —'; enText.textContent='English appears here.'; enText.style.display='none'; return; }
      faText.textContent=c.fa||'—'; enText.textContent=c.en||'—'; enText.style.display='none';
    }

    prevBtn.onclick = ()=>{ if(!cards.length) return; idx=(idx-1+cards.length)%cards.length; enText.style.display='none'; renderCard(); };
    nextBtn.onclick = ()=>{ if(!cards.length) return; idx=(idx+1)%cards.length; enText.style.display='none'; renderCard(); };
    toggleEnBtn.onclick = ()=>{ enText.style.display=(enText.style.display==='none')?'block':'none'; };

    // --- FIX: بعد از «موفق»، از اولِ لیست شروع نکن ---
    markSuccessBtn.onclick = async ()=>{
      const c = cards[idx]; if(!c) return;
      await updateDoc(c._ref,{success:true});
      c.success = true;
      toast('به عنوان «موفق» علامت خورد.');

      const shouldRemove = (hideSuccess || viewMode.value==='repeat');
      if(shouldRemove){
        // حذف از صف تکرار و ماندن روی همان ایندکس برای نمایش کارت بعدی
        cards.splice(idx,1);
        if(cards.length===0){
          totalBadge.textContent = '0 کارت';
          renderCard();
          await loadRecent();
          return;
        }
        if(idx >= cards.length) idx = 0; // اگر آخرین کارت بود
      }else{
        // در حالت نمایش همه‌ی کارت‌ها فقط برو کارت بعدی
        idx = (idx+1) % cards.length;
      }
      totalBadge.textContent = cards.length + ' کارت';
      enText.style.display='none';
      renderCard();
      await loadRecent();
    };

    incRepeatBtn.onclick = async ()=>{ const c=cards[idx]; if(!c) return; const rc=Number(c.repeatCount||0)+1; await updateDoc(c._ref,{repeatCount:rc}); c.repeatCount = rc; toast('تکرار +1 ثبت شد.'); };
    hideSuccessOn.onclick=async()=>{ hideSuccess=true; localStorage.setItem('hide_success','1'); await loadCards(); };
    hideSuccessOff.onclick=async()=>{ hideSuccess=false; localStorage.setItem('hide_success','0'); await loadCards(); };
    filterCategory.onchange=async()=>{ await loadCards(); await loadRecent(); };
    viewMode.onchange=async()=>{ await loadCards(); };
    viewOrder.onchange=async()=>{ await loadCards(); };

    addBtn.onclick = async ()=>{
      if(!ensureUID()) return;
      const newCat=newCategoryInput.value.trim();
      const cat=newCat||categorySelect.value;
      const fa=faInput.value.trim();
      const en=enInput.value.trim();
      if(!cat){ alert('سرفصل را انتخاب یا ایجاد کن.'); return; }
      if(!fa||!en){ alert('جملهٔ فارسی و ترجمهٔ انگلیسی لازم است.'); return; }
      await ensureCategory(cat);
      await addDoc(cardsCol(), { fa,en,category:cat,success:false,repeatCount:0,createdAt:serverTimestamp() });
      faInput.value=''; enInput.value=''; if(newCat) newCategoryInput.value='';
      if(newCat){ await loadCategories(); filterCategory.value=cat; }
      await loadCards(); await loadRecent(); toast('کارت ذخیره شد.');
    };
    clearBtn.onclick = ()=>{ faInput.value=''; enInput.value=''; };
    deleteBtn.onclick = async ()=>{
      const c = cards[idx]; if(!c){ alert('کارت فعالی برای حذف نیست.'); return; }
      if(!confirm('کارت فعلی حذف شود؟')) return;
      await updateDoc(c._ref,{deleted:true, fa:'', en:''}); toast('کارت حذف شد.'); await loadCards(); await loadRecent();
    };

    async function loadRecent(){
      if(!ensureUID()) return;
      recentList.innerHTML='';
      const currCat=filterCategory.value;
      if(!currCat || currCat==='__ALL__'){
        recentList.innerHTML='<div class="hint">برای دیدن لیست اخیر، یک سرفصل از بالا انتخاب کن.</div>'; return;
      }
      const snap=await getDocs(cardsCol());
      let arr=[]; snap.forEach(d=>{ const v=d.data(); if(v.category===currCat && !v.deleted) arr.push(v); });
      arr.sort((a,b)=>(a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
      arr=arr.slice(-8).reverse();
      if(!arr.length){ recentList.innerHTML='<div class="hint">هنوز کارتی برای این سرفصل ذخیره نشده.</div>'; return; }
      arr.forEach(x=>{
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`
          <div class="hint" style="margin-bottom:6px">${x.category}</div>
          <div style="font-size:14px">${x.fa||''}</div>
          <div class="hr"></div>
          <div style="font-size:12px;color:#bfe7ff">${x.en||''}</div>
          <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="badge">موفق: ${x.success?'✓':'—'}</span>
            <span class="badge">تکرار: ${x.repeatCount||0}</span>
          </div>`;
        recentList.appendChild(el);
      });
    }

    saveUidBtn.onclick = async ()=>{
      const v=uidInput.value.trim(); if(!v){ alert('UID خالی است.'); return; }
      UID=v; localStorage.setItem('flash_uid', UID);
      await loadCategories(); await loadCards(); await loadRecent(); toast('UID تنظیم شد.');
    };

    (async function boot(){
      if(!UID){
        filterCategory.innerHTML='<option>اول UID را پایین تنظیم کن</option>';
        return;
      }
      await loadCategories(); await loadCards(); await loadRecent();
    })();
  </script>
</body>
</html>
